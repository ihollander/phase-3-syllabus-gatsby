<!DOCTYPE html>
<html lang="en">
<head>
  <link rel="stylesheet" href="https://unpkg.com/mocha/mocha.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chai/4.2.0/chai.min.js" integrity="sha512-x3BwhuxT44pOQZanacQyDnrB2r1L1AUfjUaefYArTHR9sHEvvy3NSnnm5Z7GAl5YPc3+GEWFT0S34obDSzUvaQ==" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mocha/8.2.1/mocha.min.js"></script>
  <script>
    let setupDone = false

    window.top.postMessage({ type: "ready" }, "*")

    window.addEventListener("message", e => {
      // TODO: check message origin (use an env var to set origins)
      const { javascript, html, test, runTest } = e.data


      if (!setupDone) {
        const script = document.createElement("script")
        script.innerHTML = test
        document.head.append(script)
        document.body.innerHTML = `
<div id='mocha'></div>
${html}
        `
        setupDone = true
      }

      let userScript = document.body.querySelector("script")
      if (userScript) {
        userScript.remove()
      }

      userScript = document.createElement("script")
      userScript.innerHTML = `
(() => {
  ${javascript}
  ${runTest ? "runTests()" : "hideTests()"}
})()
      `
      document.body.append(userScript)
    })
  </script>

  <!-- Mocha setup -->
  <script>
    mocha.setup({
      ui: 'bdd',
      cleanReferencesAfterRun: false
    });
  </script>

  <!-- Mocha runner -->
  <script>

    const runTests = () => {
      document.querySelector("#mocha").style.display = "block"
      document.querySelector("#mocha").innerHTML = ""
      mocha.run(function(failures) {
        const isError = failures > 0
        window.top.postMessage({ type: "run_test", payload: isError }, "*")
      });
    }

    const hideTests = () => {
      document.querySelector("#mocha").style.display = "none"
    }
  </script>
</head>
<body>
</body>
</html>
